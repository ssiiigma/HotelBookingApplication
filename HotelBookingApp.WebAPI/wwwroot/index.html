<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Booking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body { background: #f8f9fa; padding-top: 20px; }
        .hotel-card { transition: transform 0.2s; cursor: pointer; height: 100%; }
        .hotel-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .section-hidden { display: none; }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }
        .hero {
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)),
            url('https://images.unsplash.com/photo-1566073771259-6a8506099945');
            background-size: cover;
            color: white;
            padding: 60px 0;
            margin-bottom: 30px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container">
        <a class="navbar-brand" href="#" onclick="showHome()">
            <i class="bi bi-building"></i> HotelBooking
        </a>
        <div class="d-flex align-items-center" id="authSection">
            <button class="btn btn-outline-light me-2" onclick="showLogin()">Login</button>
            <button class="btn btn-light" onclick="showRegister()">Register</button>
        </div>
    </div>
</nav>

<div id="notificationArea" class="notification"></div>

<div class="container" style="margin-top: 80px;">
    <div class="hero">
        <div class="container text-center">
            <h1 class="display-5 mb-3">Find Your Perfect Stay</h1>
            <div class="row justify-content-center">
                <div class="col-md-10 col-lg-8">
                    <div class="bg-white p-4 rounded shadow">
                        <h4 class="mb-3 text-dark">Search Hotels</h4>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <input type="text" class="form-control" placeholder="City (e.g., Kyiv)" id="searchCity">
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control" id="checkInDate">
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control" id="checkOutDate">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" id="searchBtn">
                                    <i class="bi bi-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="hotelsSection">
        <h3 class="mb-4">Available Hotels</h3>
        <div class="row g-4" id="hotelsList">
            <div class="col-12 text-center">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Enter city and dates above to search for hotels
                </div>
            </div>
        </div>
    </div>

    <div id="roomsSection" class="section-hidden">
        <button class="btn btn-outline-secondary mb-3" onclick="showHome()">
            <i class="bi bi-arrow-left"></i> Back to Hotels
        </button>
        <h3 id="roomsHotelName" class="mb-4"></h3>
        <div class="row g-4" id="roomsList"></div>
    </div>

    <div id="bookingSection" class="section-hidden">
        <button class="btn btn-outline-secondary mb-3" onclick="showRooms()">
            <i class="bi bi-arrow-left"></i> Back to Rooms
        </button>
        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-body">
                        <h3 id="bookingHotelName"></h3>
                        <h5 id="bookingRoomType" class="text-primary"></h5>
                        <p id="bookingRoomDescription"></p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Book This Room</h5>
                    </div>
                    <div class="card-body">
                        <form id="bookingForm">
                            <input type="hidden" id="bookingRoomId">
                            <div class="mb-3">
                                <label class="form-label">Check-in</label>
                                <input type="date" class="form-control" id="bookingCheckIn" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Check-out</label>
                                <input type="date" class="form-control" id="bookingCheckOut" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Guests</label>
                                <input type="number" class="form-control" id="bookingGuests" min="1" value="2" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Total Price</label>
                                <input type="text" class="form-control" id="bookingTotalPrice" readonly>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Confirm Booking</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Login</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="loginEmail" value="admin@hotelbooking.com" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" value="Admin123!" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Login</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Register</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" required minlength="6">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Register</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>

    
    // const API_BASE_URL = 'https://localhost:5010';
    const API_BASE_URL = "";
    let currentHotelId = null;
    let currentHotelName = null;
    let currentRoomPrice = 0;


    document.addEventListener('DOMContentLoaded', () => {
        const searchBtn = document.getElementById('searchBtn');
        if (searchBtn) {
            searchBtn.addEventListener('click', searchHotels);
        }

        loadHotels();
    });

    function showMyBookings() {
        showNotification('Feature coming soon!', 'info');
    }

    async function loadHotels() {
        try {
            const response = await fetch(`/api/hotels`);
            if (!response.ok) throw new Error('Помилка завантаження');

            const hotels = await response.json();
            renderHotels(hotels);
        } catch (err) {
            console.error('Error loading hotels:', err);
        }
    }

    function renderHotels(hotels) {
        const container = document.getElementById('hotelsContainer');
        if (!container) return;

        container.innerHTML = '';

        if (!hotels || hotels.length === 0) {
            container.innerHTML = '<p>Готелі не знайдено</p>';
            return;
        }

        hotels.forEach(hotel => {
            const div = document.createElement('div');
            div.className = 'hotel-card';
            div.innerHTML = `
            <h3>${hotel.name}</h3>
            <p>${hotel.city}</p>
            <p>Ціна від: ${hotel.pricePerNight}</p>
        `;
            div.addEventListener('click', () => {
                window.location.href = `/booking.html?hotelId=${hotel.id}`;
            });
            container.appendChild(div);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);

        document.getElementById('checkInDate').valueAsDate = tomorrow;
        document.getElementById('checkOutDate').valueAsDate = nextWeek;

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('checkInDate').min = today;
        document.getElementById('checkOutDate').min = today;

        checkAuthStatus();

    });

    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const email = document.getElementById('email').value;
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (password !== confirmPassword) {
            showNotification('Passwords do not match', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/account/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    firstName: firstName,
                    lastName: lastName,
                    password: password,
                    confirmPassword: confirmPassword
                })
            });

            const result = await response.json();

            if (result.success) {
                showNotification('Registration successful! You can now login.', 'success');
                bootstrap.Modal.getInstance(document.getElementById('registerModal')).hide();
                showLogin();
            } else {
                showNotification(result.message || 'Registration failed', 'error');
            }
        } catch (error) {
            console.error('Registration error:', error);
            showNotification('Registration error. Check console for details.', 'error');
        }
    });

    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        try {
            const response = await fetch(`/api/account/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include', 
                body: JSON.stringify({
                    email: email,
                    password: password,
                    rememberMe: false
                })
            });

            const result = await response.json();

            if (result.success) {
                showNotification('Login successful!', 'success');
                updateAuthUI(result.data);
                bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            } else {
                showNotification(result.message || 'Login failed', 'error');
            }
        } catch (error) {
            console.error('Login error:', error);
            showNotification('Login error. Check console for details.', 'error');
        }
    });

    async function checkAuthStatus() {
        try {
            const response = await fetch(`/api/account/check-auth`, {
                credentials: 'include'
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success && result.data.authenticated) {
                    updateAuthUI(result.data.user);
                }
            }
        } catch (error) {
            console.log('User not authenticated or error:', error);
        }
    }

    function updateAuthUI(userData) {
        const authSection = document.getElementById('authSection');

        authSection.innerHTML = `
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-person-circle"></i> ${userData.firstName}
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="showMyBookings()">My Bookings</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="logout()">Logout</a></li>
                </ul>
            </div>
        `;
    }

    async function logout() {
        try {
            const response = await fetch(`/api/account/logout`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json' 
                }
            });

            if (response.ok) {
                showNotification('Logged out successfully', 'success');

                document.getElementById('authSection').innerHTML = `
                <button class="btn btn-outline-light me-2" onclick="showLogin()">Login</button>
                <button class="btn btn-light" onclick="showRegister()">Register</button>
            `;
                setTimeout(() => window.location.reload(), 1000);
            }
        } catch (error) {
            console.error('Logout error:', error);
            showNotification('Logout failed', 'error');
        }
    }

    function showLogin() {
        new bootstrap.Modal(document.getElementById('loginModal')).show();
    }

    function showRegister() {
        new bootstrap.Modal(document.getElementById('registerModal')).show();
    }

    function showNotification(message, type = 'info') {
        const notificationArea = document.getElementById('notificationArea');
        const alertClass = type === 'error' ? 'alert-danger' :
            type === 'success' ? 'alert-success' : 'alert-info';

        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show`;
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        notificationArea.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    function showLoading(elementId, message = 'Loading...') {
        const element = document.getElementById(elementId);
        if (element) {
            element.innerHTML = `
                <div class="col-12 text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">${message}</p>
                </div>
            `;
        }
    }

    function showHome() {
        document.querySelectorAll('.section-hidden').forEach(el => el.classList.add('section-hidden'));
        document.getElementById('hotelsSection').classList.remove('section-hidden');
    }

    function showRooms() {
        document.querySelectorAll('.section-hidden').forEach(el => el.classList.add('section-hidden'));
        document.getElementById('roomsSection').classList.remove('section-hidden');
    }

    async function searchHotels() {
        const city = document.getElementById('searchCity').value.trim();

        if (!city) {
            showNotification('Please enter a city', 'error');
            return;
        }

        try {
            showLoading('hotelsList', 'Searching hotels...');

            const response = await fetch(
                `/api/hotels/search?city=${encodeURIComponent(city)}`
            );

            if (!response.ok) {
                throw new Error('Failed to fetch hotels');
            }

            const result = await response.json();

            const hotels = result.data ?? result;

            displayHotels(hotels);
        } catch (error) {
            console.error(error);
            showNotification('Error loading hotels', 'error');
        }
    }

    function displayHotels(hotels) {
        const hotelsList = document.getElementById('hotelsList');

        if (!hotels || hotels.length === 0) {
            hotelsList.innerHTML = `
                <div class="col-12 text-center">
                    <div class="alert alert-info">No hotels found. Try different search criteria.</div>
                </div>
            `;
            return;
        }

        hotelsList.innerHTML = hotels.map(hotel => `
            <div class="col-md-4">
                <div class="card hotel-card" onclick="showHotelRooms(${hotel.id}, '${hotel.name}')">
                    <img src="${hotel.mainImageUrl || 'https://images.unsplash.com/photo-1566073771259-6a8506099945'}" 
                         class="card-img-top" style="height: 200px; object-fit: cover;">
                    <div class="card-body">
                        <h5>${hotel.name}</h5>
                        <p><i class="bi bi-geo-alt"></i> ${hotel.city}</p>
                        <p class="text-muted">${hotel.description ? hotel.description.substring(0, 80) + '...' : ''}</p>
                        <div class="d-flex justify-content-between">
                            <span class="badge bg-primary">$${hotel.minPrice || 0} - $${hotel.maxPrice || 0}</span>
                            <span class="badge bg-success">${hotel.availableRooms || 0} rooms</span>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function displayRooms(rooms) {
        const roomsList = document.getElementById('roomsList');

        if (!rooms || rooms.length === 0) {
            roomsList.innerHTML = `
                <div class="col-12 text-center">
                    <div class="alert alert-info">No rooms available for selected dates.</div>
                </div>
            `;
            return;
        }

        roomsList.innerHTML = rooms.map(room => `
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5>${room.roomType} - Room ${room.roomNumber}</h5>
                        <p>${room.description || ''}</p>
                        <p><i class="bi bi-people"></i> ${room.capacity} guests</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="text-primary mb-0">$${room.pricePerNight}/night</h4>
                            <button class="btn btn-primary" onclick="showBookingForm(${room.id}, '${room.roomType}', ${room.pricePerNight})">
                                Book Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function showHotelRooms(hotelId, hotelName) {
        currentHotelId = hotelId;
        currentHotelName = hotelName;

        document.getElementById('roomsHotelName').textContent = hotelName;
        showRooms();

        const checkIn = document.getElementById('checkInDate').value;
        const checkOut = document.getElementById('checkOutDate').value;

        try {
            showLoading('roomsList', 'Loading rooms...');

            const response = await fetch(`/api/hotels/${hotelId}/rooms?checkIn=${checkIn}&checkOut=${checkOut}`);


            if (!response.ok) throw new Error(`HTTP error: ${response.status}`);

            const result = await response.json();
            displayRooms(result.data || []);
        } catch (error) {
            console.error('Error loading rooms:', error);
            document.getElementById('roomsList').innerHTML = `
            <div class="col-12 text-center">
                <div class="alert alert-danger">Failed to load rooms. Check server connection.</div>
            </div>
        `;
        }
    }

    function showBookingForm(roomId, roomType, pricePerNight) {
        currentRoomPrice = pricePerNight;

        document.getElementById('bookingRoomId').value = roomId;
        document.getElementById('bookingHotelName').textContent = currentHotelName;
        document.getElementById('bookingRoomType').textContent = roomType;
        document.getElementById('bookingCheckIn').value = document.getElementById('checkInDate').value;
        document.getElementById('bookingCheckOut').value = document.getElementById('checkOutDate').value;

        calculateTotalPrice();

        document.querySelectorAll('.section-hidden').forEach(el => el.classList.add('section-hidden'));
        document.getElementById('bookingSection').classList.remove('section-hidden');
    }

    function calculateTotalPrice() {
        const checkIn = new Date(document.getElementById('bookingCheckIn').value);
        const checkOut = new Date(document.getElementById('bookingCheckOut').value);
        const guests = document.getElementById('bookingGuests').value;

        if (checkIn && checkOut && checkOut > checkIn) {
            const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
            const totalPrice = nights * currentRoomPrice;
            document.getElementById('bookingTotalPrice').value = `$${totalPrice} for ${nights} nights`;
        }
    }

    document.getElementById('bookingForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const authSection = document.getElementById('authSection');
        if (authSection.innerHTML.includes('Login')) {
            showNotification('Please login to book a room', 'error');
            showLogin();
            return;
        }

        showNotification('Booking feature would be implemented here', 'info');
    });

    window.searchHotels = searchHotels;
    window.showLogin = showLogin;
    window.showRegister = showRegister;
    window.showHome = showHome;
    window.showRooms = showRooms;
    window.logout = logout;
</script>
</body>
</html>